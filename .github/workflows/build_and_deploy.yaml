name: Build the rdw-api application

on:
  push:
    branches:
      - "main"

jobs:
  static_check:
    name: Perform Static check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2 

      - name: Use golang ${{matrix.go-version}}
        uses: actions/setup-go@v2
        with:
          go-version: '^1.13.1'

      - run: go version

      - name : Download static check binary
        run: go get honnef.co/go/tools/cmd/staticcheck

      - name : Run static check
        run: $(go env GOPATH)/bin/staticcheck ./...

  lint:
    needs: static_check
    name: Perform linting
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2 
      - name: Use golang ${{matrix.go-version}}
        uses: actions/setup-go@v2
        with:
          go-version: '^1.13.1'

      - run: go version
      - name: golangci-lint
        uses: golangci/golangci-lint-action@v2
        with:
          skip-go-installation: true

  security_check:
    needs: lint
    name: Perform Security check
    runs-on: ubuntu-latest
    env:
      GO111MODULE: on
    steps:
      - uses: actions/checkout@v2 
      - name: Run Gosec Security Scanner
        uses: securego/gosec@master
        with:
          args: ./...

  build:
    name: Build the repository
    runs-on: ubuntu-latest
    needs: security_check
    steps:
      - uses: actions/checkout@v2 

      - name: Use golang ${{matrix.go-version}}
        uses: actions/setup-go@v2
        with:
          go-version: '^1.13.1'
      - run: go version

      - uses: mirromutth/mysql-action@v1.1
        with:
          host port: 3306
          container port: 3307
          character set server: 'utf8' 
          collation server: 'utf8_general_ci'
          mysql version: '8.0' 
          mysql database: 'aws-test' 
          mysql root password: 'password'
          mysql user: 'root' 
          mysql password: 'password' 

      - name: Initialize the environment variables
        run: |
          echo "SERVER_PORT=5000
          ENVIRONMENT=local
          DB_HOST=localhost
          DB_PORT=3306
          DB_NAME=aws-test
          DB_USERNAME=root
          DB_PASSWORD=password" > .env

      - name: Build the repository
        run: go build main.go

      - name: Start the service
        run: |
          ./main &